/*global window, alert, console, $, JQuery, debug, scorm, Local_API_1484_11 */
/*jslint devel: true, browser: true */
/**
 * SCORM API
 * This is a content API, it self-establishes communication with the LMS in SCORM 2004 or 1.2.
 * Switch statements will convert some SCORM 2004 calls to SCORM 1.2, but you must understand there are limitations
 * on data storage between versions. Example: Suspend Data 64,000 vs 4096 or Bookmark(location) 1000 vs 255.
 * Depending on your use, your content may not squeeze into the SCORM 1.2 available space.  Because of this, log messages
 * will be output so you can monitor your cmi "set" value length.  Ultimately, a LMS may block your request because of this.
 * This API is meant to simplify common SCORM Tasks, but also offers the ability to use it 'long hand'. Several other
 * public API's are available online, some free some charge, and this is a best effort to boil it all down.
 * Documentation, samples, resources, and credits: ADL, Claude Ostyn, Pipwerks, SCORM.com
 * Goals: SCORM For Everyone else, low overhead, simple API's, containment, and transparency.
 *
 * Typical CMI Usage (if used by itself):
 * var scorm = new SCORM_API({debug: true, exit_type: 'suspend'}),
 *     lmsconnected = scorm.initialize();
 * scorm.getvalue('cmi.location');
 * scorm.setvalue('cmi.location', '4');
 * scorm.commit();
 * scorm.terminate();
 *
 * HTML Event Setup:
 * If you choose not to use SCOBot tips for onload and onunload, onbeforeunload events you may need to make init, exit methods to do other things
 * vs. directly referencing the SCORM API here.  Feel free to make those methods if you need to.  'window.top' can be used because
 * some deployments self occur within a popup in a IFRAME will not fire properly on exit, in some Mozilla browsers.  Last checked, window worked with
 * JQuery 1.7+ however.  If you have issues trapping the unload event, please try window.top.
 * $(window).bind('load', YOUR_INITIALIZATION_METHOD);
 * $(window).bind('unload', YOUR_EXIT_METHOD);
 *
 * JSLint was recently changed and its throwing a "use spaces, not tabs" error.  I decided to switch to spaces.
 * https://github.com/douglascrockford/JSLint/pull/140
 *
 * https://github.com/cybercussion/SCOBot
 * @author Mark Statkus <mark@cybercussion.com>
 * @license Copyright (c) 2009-2014, Cybercussion Interactive LLC
 * As of 3.0.0 this code is under a Creative Commons Attribution-ShareAlike 4.0 International License.
 * @requires JQuery
 * @version 3.0.0
 * @param options {Object} override default values
 * @constructor
 */
/*!
 * SCORM_API, Updated January 3rd, 2014
 * Copyright (c) 2009-2013, Cybercussion Interactive LLC.
 * As of 3.0.0 this code is under a Creative Commons Attribution-ShareAlike 4.0 International License.
 */
function SCORM_API(a){"use strict";function h(a,b){$(g).triggerHandler({type:"debug",msg:a,lvl:b})}function i(a,b){if(c.debug){switch(window.console||(window.console={},window.console.info=h,window.console.log=h,window.console.warn=h,window.console.error=h,window.console.trace=h),b){case 1:console.error(a);break;case 2:console.warn(a);break;case 4:console.info(a);break;case 3:console.log(a);break;default:return console.log(a),!1}return!0}return 3>b&&c.throw_alerts&&alert(a),!1}function j(a){for(var b=0,c=500;!a.API&&!a.API_1484_11&&a.parent&&a.parent!==a&&c>=b;)b+=1,a=a.parent;if(a.API_1484_11)f.version="2004",f.path=a.API_1484_11;else{if(!a.API)return!1;f.version="1.2",f.path=a.API}return!0}function k(a,b){var h,i,c="P",d=Math.max(a,0),e=0,f=0,g=0;return d=Math.round(d),b===!0?g=Math.floor(d/864e4):(e=Math.floor(d/315576e4),d-=315576e4*e,f=Math.floor(d/26298e4),d-=26298e4*f,g=Math.floor(d/864e4)),d-=864e4*g,h=Math.floor(d/36e4),d-=36e4*h,i=Math.floor(d/6e3),d-=6e3*i,e>0&&(c+=e+"Y"),f>0&&(c+=f+"M"),g>0&&(c+=g+"D"),(h>0||i>0||d>0)&&(c+="T",h>0&&(c+=h+"H"),i>0&&(c+=i+"M"),d>0&&(c+=d/100+"S")),"P"===c&&(c="PT0H0M0S"),c}function l(a){var h,b=[0,0,0,0,0,0],c=!(0===a.indexOf("P")),d=!1,e=["Y","M","D","H","M","S"],f=0,g=0;if(!c){for(a=a.substr(1),h=e.length,g=0;h>g;g+=1)if(0===a.indexOf("T")&&(a=a.substr(1),g=Math.max(g,3),d=!0),f=a.indexOf(e[g]),f>-1){if(1===g&&a.indexOf("T")>-1&&a.indexOf("T")<f)continue;if(b[g]="S"===e[g]?parseFloat(a.substr(0,f)):parseInt(a.substr(0,f),10),isNaN(b[g])){c=!0;break}if(g>2&&!d){c=!0;break}a=a.substr(f+1)}c=!(c||0===h)}return c?0:315576e4*b[0]+26298e4*b[1]+864e4*b[2]+36e4*b[3]+6e3*b[4]+Math.round(100*b[5])}function m(a){return 10>a?"0"+a:a}function n(a){return a.getUTCFullYear()+"-"+m(a.getUTCMonth()+1)+"-"+m(a.getUTCDate())+"T"+m(a.getUTCHours())+":"+m(a.getUTCMinutes())+":"+m(a.getUTCSeconds())+"."+Math.round(a.getUTCMilliseconds()/1e3%1e3)+"Z"}function o(a){var b=a.getTimezoneOffset()>0?"-":"+";return a.getFullYear()+"-"+m(a.getMonth()+1)+"-"+m(a.getDate())+"T"+m(a.getHours())+":"+m(a.getMinutes())+":"+m(a.getSeconds())+"."+Math.round(a.getMilliseconds()/1e3%1e3)+b+m(Math.abs(a.getTimezoneOffset())/60)+":00"}function p(a){var d,e,h,b=["January","February","March","April","May","June","July","August","September","October","November","December"],f=0,g=0;switch(c.time_type){case"UTC":return d=a.replace(/(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})(?:\.(\d+))(|Z)/,function(a,c,d,e,f,g,h){return b[d-1]+" "+e+", "+c+" "+f+":"+g+":"+h}),h=new Date.UTC(d);case"GMT":return d=a.replace(/(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})(?:\.(\d+))([\+|\-]\d+:\d+)/,function(a,c,d,e,h,i,j,k,l){return f=60*60*60*parseInt(l.substring(1,l.length),10),g=k,b[d-1]+" "+e+", "+c+" "+h+":"+i+":"+j}),h=new Date(d),e=60*60*h.getTimezoneOffset(),e!==f&&(h=new Date(h.getTime()+f+e),h.setMilliseconds(g)),h;default:return d=a.replace(/(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})/,function(a,c,d,e,f,g,h){return b[d-1]+" "+e+", "+c+" "+f+":"+g+":"+h}),h=new Date(d)}}function q(a){var b,c,d,e,f;return a=Math.round(a),c=Math.floor(a/36e4),d=a-36e4*c,e=Math.floor(d/6e3),d-=6e3*e,f=Math.floor(d/100),d-=100*f,b="0000"+c+":",b=b.substr(b.length-5,5),10>e&&(b+="0"),b+=e+":",10>f&&(b+="0"),b+=f,d>0&&(b+=".",10>d&&(b+="0"),b+=d),b}function r(a){if(void 0===a)return i(c.prefix+" : makeBoolean was given empty string, converting to false",2),!1;if(a===!0||a===!1)return Boolean(a);switch(a.toLowerCase()){case"true":case"yes":case"1":return!0;case"false":case"no":case"0":case null:return!1;default:return Boolean(a)}}function s(a){return i(e[a],2),!0}function t(a){$(g).triggerHandler({type:"exception",error:a})}function u(){var a=f.path,b=0;if(a)switch(f.version){case"1.2":b=parseInt(a.LMSGetLastError(),10);break;case"2004":b=parseInt(a.GetLastError(),10)}return b}function v(a){var b=f.path,c="No LMS Connectivity";if(b)switch(f.version){case"1.2":c=b.LMSGetErrorString(a.toString());break;case"2004":c=b.GetErrorString(a.toString())}return String(c)}function w(a){var b=f.path,c="No LMS Connectivity";if(b)switch(f.version){case"1.2":c=b.LMSGetDiagnostic(a.toString());break;case"2004":c=b.GetDiagnostic(a.toString())}return String(c)}var b={version:"3.0.0",createDate:"04/05/2011 08:56AM",modifiedDate:"01/04/2014 12:18PM",debug:!1,isActive:!1,throw_alerts:!1,prefix:"SCORM_API",exit_type:"suspend",success_status:"unknown",use_standalone:!0,standalone:!1,completion_status:"unknown",time_type:"GMT",cmi:null},c=$.extend(b,a),d=0,e={0:"No Error",404:"Not Found",405:"Prevented on a read only resource"},f={connection:!1,version:"none",mode:"",path:!1,data:{completion_status:c.completion_status,success_status:c.success_status,exit_type:c.exit_type},isActive:c.isActive},g=this;c.error=e,c.startDate={},this.getvalue=function(a){var b=null,d=f.path,e=0,h="",j="",k=null,l=!1;if(f.isActive){switch(f.version){case"1.2":switch(a){case"cmi.comments_from_lms._count":case"cmi.comments_from_learner._count":l=!0;break;case"cmi.credit":k="cmi.core.credit";break;case"cmi.location":k="cmi.core.lesson_location";break;case"cmi.completion_threshold":l=!0;break;case"cmi.entry":k="cmi.core.entry";break;case"cmi.mode":k="cmi.core.lesson_mode";break;case"cmi.exit":k="cmi.core.exit";break;case"cmi.score.raw":k="cmi.core.score.raw";break;case"cmi.score.min":k="cmi.core.score.min";break;case"cmi.score.max":k="cmi.core.score.max";break;case"cmi.scaled_passing_score":k="cmi.student_data.mastery_score";break;case"cmi.max_time_allowed":k="cmi.student_data.max_time_allowed";break;case"cmi.time_limit_action":k="cmi.student_data.time_limit_action";break;case"cmi.learner_preferences.audio_level":k="cmi.student_preferences.audio";break;case"cmi.learner_preferences.delivery_speed":k="cmi.student_preferences.speed";break;case"cmi.learner_preferences.language":k="cmi.student_preferences.language";break;case"cmi.learner_preferences.audio_captioning":k="cmi.student_preferences.text";break;case"cmi.success_status":case"cmi.completion_status":k="cmi.core.lesson_status";break;case"cmi.session_time":k="cmi.core.session_time";break;case"cmi.suspend_data":k=a;break;default:k=a}if(l)return"false";b=d.LMSGetValue(k);break;case"2004":b=d.GetValue(a)}return e=u(),h=v(e),j=w(e),$(g).triggerHandler({type:"getvalue",n:a,v:b,error:{code:e,message:h,diagnostic:j}}),0===e||403===e?(("undefined"===b||null===b||"null"===b)&&(b=""),String(b)):(i(c.prefix+": Error\nError Code: "+e+"\nError Message: "+h+"\nDiagnostic: "+j,1),"false")}return i(c.prefix+": "+a+" Get Aborted, connection not initialized! "+f.isActive,2),"false"},this.setvalue=function(a,b){var d="false",e=f.path,h=0,j="",k="",l=null,m=!1;if(f.isActive){switch(f.version){case"1.2":if(f.mode=""===f.mode?e.LMSGetValue("cmi.core.lesson_mode"):f.mode,"normal"!==f.mode)return i(c.prefix+": Warning, you are not in normal mode.  Ignoring 'set' requests.",2),"false";switch(a){case"cmi.location":b.length>255&&i(c.prefix+": Warning, your bookmark is over the limit!!",2),l="cmi.core.lesson_location";break;case"cmi.mode":l="cmi.core.lesson_mode";break;case"cmi.exit":l="cmi.core.exit",f.exit_type=b;break;case"cmi.score.raw":l="cmi.core.score.raw";break;case"cmi.score.min":l="cmi.core.score.min";break;case"cmi.score.max":l="cmi.core.score.max";break;case"cmi.score.scaled":m=!0;break;case"cmi.success_status":case"cmi.completion_status":l="cmi.core.lesson_status",f.data.completion_status=b;break;case"cmi.scaled_passing_score":l="cmi.student_data.mastery_score";break;case"cmi.learner_preferences.audio_level":l="cmi.student_preferences.audio";break;case"cmi.learner_preferences.delivery_speed":l="cmi.student_preferences.speed";break;case"cmi.learner_preferences.language":l="cmi.student_preferences.language";break;case"cmi.learner_preferences.audio_captioning":l="cmi.student_preferences.text";break;case"cmi.session_time":l="cmi.core.session_time";break;case"cmi.total_time":l="cmi.core.total_time";break;case"cmi.suspend_data":b.length>4096&&i(c.prefix+": Warning, your suspend data is over the limit!!",2),l=a;break;default:l=a}if(m)return"false";d=e.LMSSetValue(l,b);break;case"2004":if(f.mode=""===f.mode?e.GetValue("cmi.mode"):f.mode,"normal"!==f.mode)return i(c.prefix+": Warning, you are not in normal mode.  Ignoring 'set' requests.",2),"false";switch(a){case"cmi.location":b.length>1e3&&i(c.prefix+": Warning, your bookmark is over the limit!!",2);break;case"cmi.completion_status":f.data.completion_status=b;break;case"cmi.success_status":f.data.success_status=b;break;case"cmi.exit":f.data.exit_type=b;break;case"suspend_data":b.length>64e3&&i(c.prefix+": Warning, your suspend data is over the limit!!",2)}d=e.SetValue(a,b)}return h=u(),j=v(h),k=w(h),$(g).triggerHandler({type:"setvalue",n:a,v:b,error:{code:h,message:j,diagnostic:k}}),0===h||403===h?d:(i(c.prefix+": Error\nError Code: "+h+"\nError Message: "+v(h)+" for "+a+"\nDiagnostic: "+w(h),1),d)}return i(c.prefix+": "+a+" Set Aborted, connection not initialized! Locate where you called it after you Terminated.",2),"false"},this.commit=function(){var e,a="false",b=f.path,d=0,h=new Date;if(e=(h.getTime()-c.startDate.getTime())/1e3,f.isActive){switch(i(c.prefix+": Committing data",3),f.version){case"1.2":g.setvalue("cmi.core.session_time",q(100*e)),a=b.LMSCommit("");break;case"2004":g.setvalue("cmi.session_time",k(100*e,!0)),a=b.Commit("")}return d=u(),0===d?a:(i(c.prefix+": Error\nError Code: "+d+"\nError Message: "+v(d)+" for Commit.\nDiagnostic: "+w(d),1),"false")}return i(c.prefix+": Commit Aborted, connection not initialized!",2),"false"},this.initialize=function(){i(c.prefix+": Initialize Called. \n	version: "+c.version+"\n	Modified: "+c.modifiedDate,3);var a=!1,b=f.path,d=0;if(f.isActive)i(c.prefix+": Aborted, connection already initialized!.",2);else if(b){switch(f.version){case"1.2":a=r(b.LMSInitialize(""));break;case"2004":a=r(b.Initialize(""))}if(d=u(),console.log(">>>>>>>>>>>>>>>>>>>>>>>>>>"+a+">>>>>>>>>>>>>>>>>>>>>>>>"),a&&0===d){switch(f.isActive=!0,f.data.completion_status=g.getvalue("cmi.completion_status"),c.startDate=new Date,i(c.prefix+": SCO is initialized.",3),f.data.completion_status){case"not attempted":case"unknown":g.setvalue("cmi.completion_status","incomplete");break;default:""===f.data.completion_status&&t("LMS compatibility issue, Please notify a administrator.  Completion Status is empty.")}return"true"}i(c.prefix+": Error\nError Code: "+d+"\nError Message: "+v(d)+" for Initialize.\nDiagnostic: "+w(d),1)}else i(c.prefix+": Aborted, LMS could not be located!.",2);return"false"},this.terminate=function(){var a=!1,b=f.path,d=0;if(i(c.prefix+": Terminating "+f.isActive+" "+b,4),f.isActive)if(b){switch(i(c.prefix+": completion_status = "+f.data.completion_status+"|| success_status = "+f.data.success_status,3),g.commit(),f.version){case"1.2":a=b.LMSFinish("");break;case"2004":a=b.Terminate("")}r(a)?(i(c.prefix+": Terminated.",3),f.isActive=!1):(d=u(),i(c.prefix+": Error\nError Code: "+d+"\nError Message: "+v(d)+" for Commit.\nDiagnostic: "+w(d),1))}else i(c.prefix+": Lost connection to LMS",2);else i(c.prefix+": Terminate Aborted, connection not initialized!",2);return a},this.getObjectiveByID=function(a){var d,e,b=g.getvalue("cmi.objectives._count");if(scorm.debug(c.prefix+": Set Objective - Begin search, Objective count is "+b,4),""===b||"false"===b||"-1"===b)return"false";for(b=parseInt(b,10)-1,d=b;d>=0;d-=1)if(e=g.getvalue("cmi.objectives."+d+".id"),a===e)return scorm.debug(c.prefix+": Objective ID Match on "+d,4),d;return"false"},this.getInteractionByID=function(a){var d,e,b=g.getvalue("cmi.interactions._count");if(""===b||"false"===b||"-1"===b)return"false";for(b=parseInt(b,10)-1,scorm.debug(c.prefix+": Getting interactions from count "+b,4),d=b;d>=0;d-=1)if(e=this.getvalue("cmi.interactions."+d+".id"),a===e)return scorm.debug(c.prefix+": Interaction By ID Returning "+d),d;return"false"},this.getInteractionObjectiveByID=function(a,b){var e,f,d=g.getvalue("cmi.interactions."+a+".objectives._count");if(""===d||"false"===d)return"0";for(d=parseInt(d,10)-1,scorm.debug(c.prefix+": Getting interaction objectives from count "+d,4),e=d;e>=0;e-=1)if(f=g.getvalue("cmi.interactions."+a+".objectives."+e+".id"),b===f)return scorm.debug(c.prefix+": Interaction Objective By ID Returning "+e),e;return"false"},this.getInteractionCorrectResponsesByPattern=function(a,b){var e,f,d=g.getvalue("cmi.interactions."+a+".correct_responses._count");if(""===d||"false"===d)return scorm.debug(c.prefix+": Correct Responses pattern was empty or false",4),"0";for(d=parseInt(d,10)-1,scorm.debug(c.prefix+": Getting interaction correct responses from count "+d,4),e=d;e>=0;e-=1)if(f=g.getvalue("cmi.interactions."+a+".correct_responses."+e+".pattern"),b===f)return scorm.debug(c.prefix+": Interaction Correct Responses By Pattern Returning "+e),"match";return"false"},this.init=function(){var a;try{a=window.parent,a&&a!==window&&j(window.parent)}catch(b){i(b,1)}if(!f.path)try{a=window.top.opener,j(a)}catch(d){i(d,1)}return f.path?(f.connection=!0,!0):(i(c.prefix+": I was unable to locate an API for communication",2),c.use_standalone?(i(c.prefix+": If you included Local_API_1484_11 I'll mimic the LMS.  If not, all SCORM calls will fail.",4),c.standalone=!0,f.version="2004",f.path="function"==typeof Local_API_1484_11?new Local_API_1484_11({cmi:c.cmi}):null,$(f.path).on("StoreData",function(a){$(g).triggerHandler({type:"StoreData",runtimedata:a.runtimedata})}),!0):!1)},this.getLastError=function(a){return e[a]},this.isLMSConnected=function(){return f.connection},this.set=function(a,b){switch(a){case"version":case"createDate":case"modifiedDate":case"prefix":return s(405),!1;case"isActive":f.isActive=b,c[a]=b;break;case"startDate":c[a]=new Date(b);break;default:c[a]=b}return 0!==d},this.get=function(a){return void 0===c[a]?(s(404),!1):c[a]},this.centisecsToSCORM12Duration=q,this.centisecsToISODuration=k,this.ISODurationToCentisec=l,this.isoDateToStringUTC=n,this.isoDateToString=o,this.isoStringToDate=p,this.makeBoolean=r,this.debug=i,this.init()}