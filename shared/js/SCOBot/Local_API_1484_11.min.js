/*global $, JQuery, debug, scorm */
/*jslint devel: true, browser: true, nomen: true */
/**
 * Local API_1484_11
 * Mimics LMS Connectivity in Local Mode i.e. standalone functionality
 *
 * https://github.com/cybercussion/SCOBot
 * @author Mark Statkus <mark@cybercussion.com>
 * @license Copyright (c) 2009-2014, Cybercussion Interactive LLC
 * As of 3.0.0 this code is under a Creative Commons Attribution-ShareAlike 4.0 International License.
 * @birequires JQuery
 * @version 3.0.0
 * @param options {Object} override default values
 * @constructor
 */
/*!
 * Local_API_1484_11, Updated January 3rd, 2014
 * Copyright (c) 2009-2013, Cybercussion Interactive LLC.
 * As of 3.0.0 this code is under a Creative Commons Attribution-ShareAlike 4.0 International License.
 */
function Local_API_1484_11(a){"use strict";function k(a,b){return c.diganostic="The "+a+" of "+b+" must be a proper vocabulary element.",c.errorCode=406,"false"}function l(a){return c.errorCode=402,c.diagnostic="The value for key "+a+" has not been created yet.","false"}function m(a,b,d){return c.errorCode="351",c.diagnostic="The "+a+" element must be unique.  The value '"+b+"' has already been set in #"+d,"false"}function n(a,b,c){var d=a.split(/\./);d.length<2?c[d[0]]=b:(c[d[0]]||(c[d[0]]={}),c=c[d.shift()],n(d.join("."),b,c))}function o(a,b){var d,c=a.split(/\./);if(!(c.length<2))return d=c.shift(),b[d]?String(o(c.join("."),b[d])):(l(a),"false");try{return b[c[0]]}catch(e){return l(a),"false"}}function p(a){var b="false";switch(a){case"cmi.exit":case"cmi.session_time":c.errorCode=405,c.diagnostic="Sorry, this has been specified as a read-only value for "+a;break;default:b=o(a.substr(4,a.length),d),"undefined"===b&&(c.errorCode=401,c.diagnostic="Sorry, there was a undefined response from "+a,b="false"),scorm.debug(c.prefix+": GetValue "+a+" = "+b,4)}return b}function q(a){var b=a.split("."),c=b[b.length-1];return"adl"===b[0]&&"id"===b[4]?!0:"comments_from_lms"===b[1]?!0:"comments_from_learner"===b[1]?!1:f.indexOf("|"+c+"|")>=0}function r(a){var b=a.split("."),c=b[b.length-1];return g.indexOf("|"+c+"|")>=0}function s(a){var b=2;return Math.round(a*Math.pow(10,b))/Math.pow(10,b)}function t(a){var b,c=0;for(b in a)a.hasOwnProperty(b)&&(c+=1);return c}function u(){"suspend"===d.exit&&(d.entry="resume")}function v(){return s(100*(d.suspend_data.length/64e3))+"%"}var b={version:"3.0.0",createdate:"07/17/2010 08:15AM",moddate:"01/03/2014 12:16PM",prefix:"Local_API_1484_11",errorCode:0,diagnostic:"",initialized:0,terminated:0,CMI:{_version:"Local 1.0",comments_from_learner:{_children:"comment,location,timestamp",_count:"0"},comments_from_lms:{_children:"comment,location,timestamp",_count:"0"},completion_status:"unknown",completion_threshold:"0.7",credit:"no-credit",entry:"ab-initio",exit:"",interactions:{_children:"id,type,objectives,timestamp,correct_responses,weighting,learner_response,result,latency,description",_count:"0"},launch_data:"?name1=value1&name2=value2&name3=value3",learner_id:"100",learner_name:"Simulated User",learner_preference:{_children:"audio_level,language,delivery_speed,audio_captioning",audio_level:"1",language:"",delivery_speed:"1",audio_captioning:"0"},location:"",max_time_allowed:"",mode:"normal",objectives:{_children:"id,score,success_status,completion_status,description",_count:"0"},progress_measure:"",scaled_passing_score:"0.7",score:{_children:"scaled,raw,min,max",scaled:"",raw:"",min:"",max:""},session_time:"PT0H0M0S",success_status:"unknown",suspend_data:"",time_limit_action:"",total_time:"PT0H0M0S"}},c=$.extend(b,a),d={},e="|completed|incomplete|not attempted|unknown|",f="|_version|completion_threshold|credit|entry|launch_data|learner_id|learner_name|_children|_count|mode|maximum_time_allowed|scaled_passing_score|time_limit_action|total_time|comment|",g="|exit|session_time|",h="|time-out|suspend|logout|normal||",i={0:"No error",101:"General exception",102:"General Initialization Failure",103:"Already Initialized",104:"Content Instance Terminated",111:"General Termination Failure",112:"Termination Before Initialization",113:"Termination After Termination",122:"Retrieve Data Before Initialization",123:"Retrieve Data After Termination",132:"Store Data Before Initialization",133:"Store Data After Termination",142:"Commit Before Initialization",143:"Commit After Termination",201:"General Argument Error",301:"General Get Failure",351:"General Set Failure",391:"General Commit Failure",401:"Undefined Data Model",402:"Unimplemented Data Model Element",403:"Data Model Element Value Not Initialized",404:"Data Model Element Is Read Only",405:"Data Model Element Is Write Only",406:"Data Model Element Type Mismatch",407:"Data Model Element Value Out Of Range",408:"Data Model Dependency Not Established"},j=this;this.isRunning=function(){return 1===c.initialized&&0===c.terminated},this.Initialize=function(){return scorm.debug(c.prefix+":  Initializing...",3),null!==c.cmi?(d=c.cmi,u()):d=c.CMI,c.initialized=1,c.terminated=0,"true"},this.GetValue=function(a){c.errorCode=0;var b="false",d=a.toString(),e=[];if(this.isRunning()){if(r(d))return scorm.debug(c.prefix+": This "+d+" is write only",4),c.errorCode=405,"false";switch(e=d.toLowerCase().split("."),e[0]){case"cmi":b=p(d);break;case"ssp":break;case"adl":}return b}return c.errorCode=123,b},this.SetValue=function(a,b){scorm.debug(c.prefix+": SetValue: "+a+" = "+b,4),c.errorCode=0;var f=[],g=a.toString(),i=b.toString(),j=0,l=0,o=[];if(this.isRunning()){if(q(g))return scorm.debug(c.prefix+": This "+g+" is read only",4),c.errorCode=404,"false";switch(f=g.split("."),f[0]){case"cmi":switch(a){case"cmi.location":i.length>1e3&&scorm.debug(c.prefix+": Some LMS's might truncate your bookmark as you've passed "+i.length+" characters of bookmarking data",2);break;case"cmi.completion_status":if(-1===e.indexOf("|"+i+"|"))return k(a,i);break;case"cmi.exit":if(-1===h.indexOf("|"+i+"|"))return k(a,i);break;default:switch(f[1]){case"comments_from_lms":return c.errorCode="404",c.diagnostic="The cmi.comments_from_lms element is entirely read only.","false";case"comments_from_learner":return-1===d.comments_from_learner._children.indexOf(f[3])?k(a,i):(n(g.substr(4,g.length),i,d),d.comments_from_learner._count=(t(d.comments_from_learner)-2).toString(),"true");case"interactions":if(-1===d.interactions._children.indexOf(f[3]))return k(a,i);if(d.interactions._count=(t(d.interactions)-2).toString(),isNaN(parseInt(f[2],10)))return"false";if(!$.isPlainObject(d.interactions[f[2]]))return"id"===f[3]?(d.interactions[f[2]]={},n(g.substr(4,g.length),i,d),d.interactions._count=(t(d.interactions)-2).toString(),$.isPlainObject(d.interactions[f[2]].objectives)||(scorm.debug(c.prefix+": Constructing objectives object for new interaction",4),d.interactions[f[2]].objectives={},d.interactions[f[2]].objectives._count="-1"),$.isPlainObject(d.interactions[f[2]].correct_responses)||(scorm.debug(c.prefix+": Constructing correct responses object for new interaction",4),d.interactions[f[2]].correct_responses={},d.interactions[f[2]].correct_responses._count="-1"),"true"):(scorm.debug("Can't add interaction without ID first!",3),"false");if("objectives"===f[3]){if("id"!==f[5])return k(a,i);for(l=parseInt(d.interactions[f[2]].objectives._count,10),j=0;l>j;j+=1)if(d.interactions[f[2]].objectives[j].id===i)return m(a,i,j);return n(g.substr(4,g.length),i,d),d.interactions[f[2]].objectives._count=(t(d.interactions[f[2]].objectives)-1).toString(),"true"}return"correct_responses"===f[3]&&(n(g.substr(4,g.length),i,d),d.interactions[f[2]].correct_responses._count=(t(d.interactions[f[2]].correct_responses)-1).toString()),n(g.substr(4,g.length),i,d),d.interactions._count=(t(d.interactions)-2).toString(),"true";case"objectives":if("id"===f[3])for(l=parseInt(d.objectives._count,10),j=0;l>j;j+=1)if(d.objectives[j].id===i)return c.errorCode="351",c.diagnostic="The objectives.id element must be unique.  The value '"+i+"' has already been set in objective #"+j,"false";return"id"!==f[3]&&(o=parseInt(f[2],10),void 0===d.objectives[o])?(c.errorCode="408",c.diagnostic="The objectives.id element must be set before other elements can be set","false"):isNaN(parseInt(f[2],10))?"false":(n(g.substr(4,g.length),i,d),d.objectives._count=(t(d.objectives)-2).toString(),"true")}}n(g.substr(4,g.length),i,d);break;case"ssp":break;case"adl":}return"true"}return c.errorCode=c.terminated?133:132,"false"},this.Commit=function(){return scorm.debug(c.prefix+": Commit CMI Object:",4),scorm.debug(d),scorm.debug(c.prefix+": Suspend Data Usage "+v()),$(j).triggerHandler({type:"StoreData",runtimedata:d}),"true"},this.Terminate=function(){return j.Commit(),c.terminated=1,c.initialized=0,"true"},this.GetErrorString=function(a){if(""!==a){var b=parseInt(a,10);if(void 0!==i[b])return i[b]}return""},this.GetLastError=function(){return c.errorCode},this.GetDiagnostic=function(){return c.diagnostic}}